
struct ast_variable *ast_http_get_post_vars(
	struct ast_tcptls_session_instance *ser, struct ast_variable *headers)
{
	int content_length = 0;
	struct ast_variable *v, *post_vars=NULL, *prev = NULL;
	char *buf, *var, *val;
	for (v = headers; v; v = v->next) {
		if (!strcasecmp(v->name, "Content-Type")) {
			if (strcasecmp(v->value, "application/x-www-form-urlencoded")) {
				return NULL;
			}
			break;
		}
	}
	for (v = headers; v; v = v->next) {
		if (!strcasecmp(v->name, "Content-Length")) {
			content_length = atoi(v->value) + 1;
			break;
		}
	}
	if (!content_length) {
		return NULL;
	}
	if (!(buf = alloca(content_length))) {
		return NULL;
	}
	if (!fgets(buf, content_length, ser->f)) {
		return NULL;
	}
	while ((val = strsep(&buf, "&"))) {
		var = strsep(&val, "=");
		if (val) {
			http_decode(val);
		} else  {
			val = "";
		}
		http_decode(var);
		if ((v = ast_variable_new(var, val, ""))) {
			if (post_vars) {
				prev->next = v;
			} else {
				post_vars = v;
			}
			prev = v;
		}
	}
	return post_vars;
}
