
static int process_crypto(struct sip_pvt *p, struct ast_rtp_instance *rtp, struct sip_srtp **srtp, const char *a)
{
	if (strncasecmp(a, "crypto:", 7)) {
		return FALSE;
	}
	if (!*srtp) {
		if (ast_test_flag(&p->flags[0], SIP_OUTGOING)) {
			ast_log(LOG_WARNING, "Ignoring unexpected crypto attribute in SDP answer\n");
			return FALSE;
		}
		if (setup_srtp(srtp) < 0) {
			return FALSE;
		}
	}
	/* For now, when we receive an INVITE just take the first successful crypto line */
	if ((*srtp)->crypto && !ast_test_flag(&p->flags[0], SIP_OUTGOING)) {
		ast_debug(3, "We've already processed a crypto attribute, skipping '%s'\n", a);
		return FALSE;
	}
	if (!(*srtp)->crypto && !((*srtp)->crypto = sdp_crypto_setup())) {
		return FALSE;
	}
	if (sdp_crypto_process((*srtp)->crypto, a, rtp) < 0) {
		return FALSE;
	}
	ast_set_flag(*srtp, SRTP_CRYPTO_OFFER_OK);
	return TRUE;
}
