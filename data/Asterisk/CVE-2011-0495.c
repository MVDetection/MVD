
char *ast_uri_encode(const char *string, char *outbuf, int buflen, int doreserved) 
{
	char *reserved = ";/?:@&=+$,# ";	/* Reserved chars */
 	const char *ptr  = string;	/* Start with the string */
	char *out = outbuf;
	/* If there's no characters to convert, just go through and copy the string */
	while (*ptr && out - outbuf < buflen - 1) {
		if ((*ptr < 32) || (doreserved && strchr(reserved, *ptr))) {
			if (out - outbuf >= buflen - 3) {
				break;
			}
			out += sprintf(out, "%%%02x", (unsigned char) *ptr);
		} else {
			*out = *ptr;	/* copy the character */
			out++;
		}
		ptr++;
	}
	if (buflen) {
		*out = '\0';
	}
	return outbuf;
}
